name: Release
# Trigger refresh comment

on:
  workflow_run:
    workflows:
      - Rust CI
    branches:
      - master
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

env:
  RELEASE_REF: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

jobs:
  version-check:
    name: Detect version change
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    outputs:
      should_release: ${{ steps.version.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_REF }}
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Fetch tags
        run: git fetch --tags --force
      - id: version
        name: Check version bump
        run: |
          set -euo pipefail
          current_version="$(python3 -c 'import tomllib; from pathlib import Path; data = tomllib.loads(Path("crates/subtitle-fast/Cargo.toml").read_text(encoding="utf-8")); print(data["package"]["version"])')"

          tag="v${current_version}"
          tag_exists="false"
          if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
            tag_exists="true"
          fi

          should_release="false"
          if [ "${tag_exists}" = "false" ]; then
            should_release="true"
          fi

          echo "version=${current_version}" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "should_release=${should_release}" >> "${GITHUB_OUTPUT}"

  build:
    name: Build release artifacts
    needs: version-check
    if: needs.version-check.outputs.should_release == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-14
          - windows-latest
    env:
      VERSION: ${{ needs.version-check.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_REF }}

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.92.0

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            nasm \
            ninja-build \
            patch \
            pkg-config \
            python3 \
            python3-pip \
            libfuse2 \
            libxcb1-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libssl-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew list --formula nasm >/dev/null 2>&1 || brew install nasm
          brew list --formula pkg-config >/dev/null 2>&1 || brew install pkg-config

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: true
          path-type: inherit
          install: >-
            make
            nasm
            patch
            curl
            tar
            file

      - name: Install appimagetool (Linux)
        if: runner.os == 'Linux'
        run: |
          curl -fL -o appimagetool.AppImage \
            https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool.AppImage
          sudo mv appimagetool.AppImage /usr/local/bin/appimagetool

      - name: Setup Python venv (macOS)
        if: runner.os == 'macOS'
        run: |
          python3 -m venv .venv
          echo "${PWD}/.venv/bin" >> "${GITHUB_PATH}"

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build ONNX Runtime (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./scripts/build-onnxruntime.sh --ops-config models/ch_PP-OCRv5_rec_infer.config

      - name: Build ONNX Runtime (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./scripts/build-onnxruntime.ps1 -OpsConfig models\ch_PP-OCRv5_rec_infer.config

      - name: Build FFmpeg (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./scripts/build-ffmpeg-min.sh

      - name: Build FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        env:
          FFMPEG_TOOLCHAIN: msvc
        run: ./scripts/build-ffmpeg-min.sh

      - name: Build CLI (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          cargo build --release --bin subtitle-fast --no-default-features \
            --features "backend-ffmpeg,ocr-ort"
      - name: Build CLI (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          cargo build --release --bin subtitle-fast --no-default-features \
            --features "backend-videotoolbox,backend-ffmpeg,detector-vision,ocr-vision,ocr-ort"
      - name: Build CLI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cargo build --release --bin subtitle-fast --no-default-features `
            --features "backend-ffmpeg,backend-dxva,backend-mft,ocr-ort"

      - name: Package CLI (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          mkdir -p target/bundle/linux
          ARCH="$(uname -m)"
          if [ "${ARCH}" = "aarch64" ]; then
            ARCH="arm64"
          fi
          tar -czf "target/bundle/linux/subtitle-fast-cli-${VERSION}-linux-${ARCH}.tar.gz" \
            -C target/release subtitle-fast

      - name: Package CLI (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          mkdir -p target/bundle/macos
          ARCH="$(uname -m)"
          if [ "${ARCH}" = "aarch64" ]; then
            ARCH="arm64"
          fi
          tar -czf "target/bundle/macos/subtitle-fast-cli-${VERSION}-macos-${ARCH}.tar.gz" \
            -C target/release subtitle-fast

      - name: Package CLI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $dist = "target\\bundle\\windows"
          New-Item -ItemType Directory -Force -Path $dist | Out-Null
          $arch = $env:PROCESSOR_ARCHITECTURE
          switch ($arch) {
            "AMD64" { $arch = "x86_64" }
            "ARM64" { $arch = "arm64" }
            "x86" { $arch = "x86" }
          }
          Compress-Archive -Path "target\\release\\subtitle-fast.exe" `
            -DestinationPath "$dist\\subtitle-fast-cli-$env:VERSION-windows-$arch.zip"

      - name: Build GUI (Linux)
        if: runner.os == 'Linux'
        run: ./scripts/build-linux-package.sh

      - name: Build GUI (macOS)
        if: runner.os == 'macOS'
        run: ./scripts/build-macos-bundle.sh

      - name: Build GUI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cargo build --release --bin subtitle-fast --no-default-features `
            --features "gui,backend-ffmpeg,backend-dxva,backend-mft,ocr-ort"

      - name: Package GUI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $dist = "target\\bundle\\windows"
          New-Item -ItemType Directory -Force -Path $dist | Out-Null
          $arch = $env:PROCESSOR_ARCHITECTURE
          switch ($arch) {
            "AMD64" { $arch = "x86_64" }
            "ARM64" { $arch = "arm64" }
            "x86" { $arch = "x86" }
          }
          Compress-Archive -Path "target\\release\\subtitle-fast.exe" `
            -DestinationPath "$dist\\subtitle-fast-gui-$env:VERSION-windows-$arch.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ runner.os }}
          path: |
            target/bundle/**/*.zip
            target/bundle/**/*.tar.gz
            target/bundle/**/*.AppImage

  release:
    name: Create GitHub release
    needs: [version-check, build]
    if: needs.version-check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version-check.outputs.tag }}
          name: ${{ needs.version-check.outputs.tag }}
          target_commitish: ${{ env.RELEASE_REF }}
          generate_release_notes: true
          files: |
            dist/**/*.zip
            dist/**/*.tar.gz
            dist/**/*.AppImage
